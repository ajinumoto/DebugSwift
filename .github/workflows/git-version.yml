name: Auto Tag and Version

on:
  push:
    branches: 
      - "main"
  workflow_dispatch:

permissions:
   actions: write
   checks: write
   contents: write
   deployments: write
   issues: write
   packages: write
   pull-requests: write
   repository-projects: write
   security-events: write
   statuses: write

jobs:
  git_version:
    name: Determine current version
    runs-on: macos-15
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
      majorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}
      preReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}
      preReleaseNumber: ${{ steps.gitversion.outputs.preReleaseNumber }}

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4
      with:
        versionSpec: '6.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4

    - name: Display GitVersion
      run: |
        NEW_TAG="${{ steps.gitversion.outputs.semVer }}"
        echo "Semantic Version: $NEW_TAG"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

  tag:
    name: Create tag and update podspec
    needs: 
      - git_version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:

    - name: Checkout
      uses: actions/checkout@v6
      with:
        token: ${{ secrets.BYPASS_TOKEN || secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Update podspec version
      run: |
        NEW_VERSION="${{ needs.git_version.outputs.majorMinorPatch }}"
        echo "Updating podspec version to: $NEW_VERSION"
        
        # Update the version in DebugSwift.podspec
        sed -i "s/s\.version.*=.*/s.version          = '$NEW_VERSION'/" DebugSwift.podspec
        
        # Verify the change
        grep "s.version" DebugSwift.podspec

    - name: Commit podspec changes
      env:
        GITHUB_TOKEN: ${{ secrets.BYPASS_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        
        NEW_VERSION="${{ needs.git_version.outputs.majorMinorPatch }}"
        CURRENT_BRANCH="${{ github.ref_name }}"
        
        # Check if there are changes to commit
        if git diff --quiet DebugSwift.podspec; then
          echo "No changes to podspec version"
        else
          git add DebugSwift.podspec
          git commit -m "chore: update podspec version to $NEW_VERSION [skip ci]"
          
          # Push to the appropriate branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Pushing to main branch"
            git push origin main
          else
            echo "Pushing to current branch: $CURRENT_BRANCH"
            git push origin HEAD
          fi
        fi

    - name: Push Git Tag
      env:
        GITHUB_TOKEN: ${{ secrets.BYPASS_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        
        TAG_NAME="${{ needs.git_version.outputs.semVer }}"
        
        # Only create and push tags when on main branch
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "Creating and pushing tag: $TAG_NAME"
          git tag $TAG_NAME
          git push origin $TAG_NAME
        else
          echo "Not on main branch, skipping tag creation"
        fi

  build_xcframework:
    name: Build and Upload XCFramework  
    needs: git_version
    runs-on: macos-15
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'

    - name: Build XCFramework
      run: |
        echo "üèóÔ∏è  Building XCFramework for release..."
        
        # Create output directories
        mkdir -p build XCFramework
        
        # Build for iOS device (arm64)
        echo "üì± Building for iOS device (arm64)..."
        xcodebuild -scheme DebugSwift \
          -destination "generic/platform=iOS" \
          -archivePath "build/DebugSwift-iOS.xcarchive" \
          archive \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
        
        # Build for iOS Simulator (arm64 + x86_64)
        echo "üñ•Ô∏è  Building for iOS Simulator..."
        xcodebuild -scheme DebugSwift \
          -destination "generic/platform=iOS Simulator" \
          -archivePath "build/DebugSwift-Simulator.xcarchive" \
          archive \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
        
        # Create XCFramework
        echo "üî® Creating XCFramework..."
        xcodebuild -create-xcframework \
          -archive "build/DebugSwift-iOS.xcarchive" -framework DebugSwift.framework \
          -archive "build/DebugSwift-Simulator.xcarchive" -framework DebugSwift.framework \
          -output "XCFramework/DebugSwift.xcframework"
        
        # Create ZIP of XCFramework
        echo "üì¶ Creating XCFramework ZIP..."
        cd XCFramework
        zip -r "DebugSwift.xcframework.zip" "DebugSwift.xcframework"
        cd ..
        
        echo "‚úÖ XCFramework created successfully!"
        echo "üìä Build output:"
        ls -la XCFramework/
        
        # Show file sizes
        echo "üìè File sizes:"
        du -h XCFramework/*

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.git_version.outputs.semVer }}
        release_name: Release ${{ needs.git_version.outputs.semVer }}
        body: |
          üöÄ **Release ${{ needs.git_version.outputs.semVer }}**
          
          **What's New:**
          - Auto-generated from main branch
          - Includes XCFramework for iOS development
          
          **Installation:**
          1. Download `DebugSwift.xcframework.zip`
          2. Extract and add to your Xcode project
          3. Link the framework to your target
          
          **Version Details:**
          - Semantic Version: ${{ needs.git_version.outputs.semVer }}
          - Major.Minor.Patch: ${{ needs.git_version.outputs.majorMinorPatch }}
        draft: false
        prerelease: false

    - name: Upload XCFramework to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./XCFramework/DebugSwift.xcframework.zip
        asset_name: DebugSwift.xcframework.zip
        asset_content_type: application/zip


