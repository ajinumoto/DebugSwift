name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v1.0.0)'
        required: true
      release_name:
        description: 'Release name'
        required: true
      is_prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
   contents: write

jobs:
  create_release:
    name: Create Release
    runs-on: macos-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v6

    - name: Get latest release
      uses: octokit/request-action@v2.x
      id: get_release
      continue-on-error: true
      with:
        route: GET /repos/:repository/releases/latest
        repository: ${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract previous tag
      id: previous_tag
      run: |
        if [ "${{ steps.get_release.outcome }}" == "success" ]; then
          json='${{ steps.get_release.outputs.data }}'
          tag=$(echo "$json" | grep -o '"tag_name": *"[^"]*"' | awk -F'"' '{print $4}')
          echo "PREVIOUS_TAG=$tag" >> $GITHUB_OUTPUT
        else
          echo "PREVIOUS_TAG=" >> $GITHUB_OUTPUT
        fi

    - name: Extract version from tag
      id: extract_version
      run: |
        TAG_NAME="${{ github.event.inputs.tag_name }}"
        # Remove 'v' prefix if present
        VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Update podspec version
      run: |
        VERSION="${{ steps.extract_version.outputs.VERSION }}"
        echo "Updating podspec version to: $VERSION"
        
        # Update the version in DebugSwift.podspec
        sed -i "s/s\.version.*=.*/s.version          = '$VERSION'/" DebugSwift.podspec
        
        # Verify the change
        grep "s.version" DebugSwift.podspec

    - name: Commit podspec changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        
        VERSION="${{ steps.extract_version.outputs.VERSION }}"
        
        # For manual releases, we just update the podspec for the artifact
        # The commit will be made separately if needed
        echo "Podspec updated to version $VERSION for manual release"
        echo "Skipping commit for manual release workflow"
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.tag_name }}
        release_name: ${{ github.event.inputs.release_name }}
        body: |
          ${{ steps.previous_tag.outputs.PREVIOUS_TAG && format('Full changelog: [{0}...{1}](https://github.com/{2}/compare/{0}...{1})', steps.previous_tag.outputs.PREVIOUS_TAG, github.event.inputs.tag_name, github.repository) || 'Initial release' }}
        draft: false
        prerelease: ${{ github.event.inputs.is_prerelease == 'true' }}

    - name: Build Static Libraries
      run: |
        echo "ðŸ—ï¸  Building DebugSwift Static Libraries using Xcode..."
        
        # Clean environment
        rm -rf .build* XCFramework build* 2>/dev/null || true
        mkdir -p XCFramework/DebugSwift-StaticLibraries
        
        echo "ðŸ“± Building for iOS device..."
        xcodebuild -scheme DebugSwift \
          -destination "generic/platform=iOS" \
          -configuration Release \
          -derivedDataPath build-ios \
          build \
          BUILD_LIBRARY_FOR_DISTRIBUTION=NO \
          SKIP_INSTALL=NO \
          ONLY_ACTIVE_ARCH=NO
        
        echo "ðŸ”¨ Creating iOS static library..."
        cd build-ios/Build/Products/Release-iphoneos/
        ar rcs libDebugSwift-ios.a DebugSwift.o
        
        echo "ðŸ“¦ iOS library created:"
        ls -la libDebugSwift-ios.a
        file libDebugSwift-ios.a
        
        # Copy to target directory
        cp libDebugSwift-ios.a ../../../../XCFramework/DebugSwift-StaticLibraries/
        cp -R DebugSwift.swiftmodule ../../../../XCFramework/DebugSwift-StaticLibraries/
        cd ../../../../
        
        echo "ðŸ–¥ï¸  Building for iOS Simulator..."
        xcodebuild -scheme DebugSwift \
          -destination "generic/platform=iOS Simulator" \
          -configuration Release \
          -derivedDataPath build-simulator \
          build \
          BUILD_LIBRARY_FOR_DISTRIBUTION=NO \
          SKIP_INSTALL=NO \
          ONLY_ACTIVE_ARCH=NO
        
        echo "ðŸ”¨ Creating simulator static library..."
        cd build-simulator/Build/Products/Release-iphonesimulator/
        ar rcs libDebugSwift-simulator.a DebugSwift.o
        
        echo "ðŸ“¦ Simulator library created:"
        ls -la libDebugSwift-simulator.a
        file libDebugSwift-simulator.a
        
        # Copy to target directory  
        cp libDebugSwift-simulator.a ../../../../XCFramework/DebugSwift-StaticLibraries/
        cp -R DebugSwift.swiftmodule ../../../../XCFramework/DebugSwift-StaticLibraries/DebugSwift-Simulator.swiftmodule
        cd ../../../../
        
        echo "ðŸ“ Creating documentation..."
        
        # Create README
        cat > XCFramework/DebugSwift-StaticLibraries/README.md << 'EOF'
        # DebugSwift Static Libraries

        This package contains static libraries for DebugSwift framework built with Xcode.

        ## Contents
        - `libDebugSwift-ios.a` - iOS device build (arm64)
        - `libDebugSwift-simulator.a` - iOS simulator build (universal arm64+x86_64)
        - Swift modules for both architectures

        ## Installation & Usage

        ### Xcode Integration
        1. Drag both `.a` files into your Xcode project
        2. Add them to your target's "Frameworks, Libraries, and Embedded Content"
        3. Set "Embed" to "Do Not Embed" (they're static libraries)
        4. Add Swift module directories to "Swift Compiler - Search Paths" 
        5. Add `import DebugSwift` to your Swift files

        ### Build Configuration
        The correct library will be automatically selected based on your build target:
        - iOS Device builds will use `libDebugSwift-ios.a`
        - iOS Simulator builds will use `libDebugSwift-simulator.a`

        ## Architecture Support
        - iOS Device: arm64
        - iOS Simulator: arm64 + x86_64 (universal)
        - Minimum iOS Version: 14.0

        ## Integration Example
        ```swift
        import DebugSwift
        
        // Initialize DebugSwift in your AppDelegate or App struct
        DebugSwift.shared.start()
        ```

        ## Troubleshooting
        - **"No such module 'DebugSwift'"**: Check Swift Import Paths in build settings
        - **Linking errors**: Ensure both .a files are added to target
        - **Simulator issues**: Verify you're using the simulator library for simulator builds
        EOF

        # Create usage guide
        cat > XCFramework/DebugSwift-StaticLibraries/USAGE_GUIDE.md << 'EOF'
        # DebugSwift Static Library Integration Guide

        ## Quick Start Steps

        1. **Download & Extract**:
           - Download `DebugSwift-StaticLibraries.zip`
           - Extract to get the `.a` files and Swift modules

        2. **Add to Xcode Project**:
           - Drag `libDebugSwift-ios.a` and `libDebugSwift-simulator.a` into your project
           - Choose "Add to target" for your main app target
           - Select "Create groups" (not folder references)

        3. **Configure Build Settings**:
           - Target â†’ Build Settings â†’ Library Search Paths â†’ Add path to .a files
           - Target â†’ Build Settings â†’ Swift Import Paths â†’ Add paths to .swiftmodule directories

        4. **Use in Code**:
           ```swift
           import DebugSwift
           
           class AppDelegate: UIResponder, UIApplicationDelegate {
               func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
                   DebugSwift.shared.start()
                   return true
               }
           }
           ```

        ## File Structure After Integration
        ```
        YourProject/
        â”œâ”€â”€ DebugSwift-StaticLibraries/
        â”‚   â”œâ”€â”€ libDebugSwift-ios.a
        â”‚   â”œâ”€â”€ libDebugSwift-simulator.a
        â”‚   â”œâ”€â”€ DebugSwift.swiftmodule/
        â”‚   â””â”€â”€ DebugSwift-Simulator.swiftmodule/
        â””â”€â”€ YourApp/
            â””â”€â”€ (your app files)
        ```

        ## Build Settings Configuration
        Add these paths to your target's build settings:
        - **Library Search Paths**: `$(PROJECT_DIR)/DebugSwift-StaticLibraries`
        - **Swift Import Paths**: 
          - `$(PROJECT_DIR)/DebugSwift-StaticLibraries/DebugSwift.swiftmodule`
          - `$(PROJECT_DIR)/DebugSwift-StaticLibraries/DebugSwift-Simulator.swiftmodule`
        EOF
        
        echo "ðŸ“¦ Creating ZIP package..."
        cd XCFramework
        zip -r "DebugSwift-StaticLibraries.zip" "DebugSwift-StaticLibraries"
        cd ..
        
        echo "âœ… Build completed successfully!"
        ls -la XCFramework/

    - name: Upload Static Libraries to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./XCFramework/DebugSwift-StaticLibraries.zip
        asset_name: DebugSwift-StaticLibraries.zip
        asset_content_type: application/zip

 